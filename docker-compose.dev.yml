# ============================================
# Docker Compose Configuration
# Full-Stack Application: PostgreSQL + NestJS + Next.js
# ============================================

services:
  # ==========================================
  # PostgreSQL Database Service (OPTIONAL - Local Development)
  # ==========================================
  # Uncomment this service if you want to use a local database
  # instead of the external Supabase database
  db:
    image: postgres:16-alpine
    container_name: trash2cash-db
    restart: unless-stopped
    profiles:
      - local-db
    environment:
      POSTGRES_USER: trash2cash
      POSTGRES_PASSWORD: trash2cash_dev_password
      POSTGRES_DB: trash2cash
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - trash2cash-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trash2cash"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # NestJS Backend Service
  # ==========================================

  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: trash2cash-backend
    restart: unless-stopped
    ports:
      # Expose backend on host port 4000
      - "4000:4000"
    environment:
      # Database connection (using external Supabase database)
      # Accept common variants; prefer explicit DATABASE_URL, fall back to Databaseurl
      DATABASE_URL: ${DATABASE_URL:-${Databaseurl}}
      Databaseurl: ${Databaseurl}
      DIRECT_URL: ${DIRECT_URL}

      # Application settings
      PORT: ${PORT:-4000}
      NODE_ENV: ${NODE_ENV:-development}

      # JWT secrets (change these in production!)
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_ACCESS_EXPIRES: ${JWT_ACCESS_EXPIRES:-15m}
      JWT_REFRESH_EXPIRES: ${JWT_REFRESH_EXPIRES:-7d}

      # CORS - allow frontend to communicate with backend
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}

      # External API keys (loaded from .env file)
      GEMINI_API_KEY: ${GEMINI_API_KEY}

      # Text.lk SMS Gateway
      TEXTLK_API_TOKEN: ${TEXTLK_API_TOKEN}
      TEXTLK_SENDER_ID: ${TEXTLK_SENDER_ID:-TextLKDemo}
      # Note: Supabase env vars removed; runtime uses DATABASE_URL only
    volumes:
      # Mount source code for hot reload in development
      - ./server/src:/app/src
      - ./server/prisma:/app/prisma
      # Persist logs
      - ./server/logs:/app/logs
      # Persist node_modules from the image (do not mount host path here)
    networks:
      - trash2cash-network
    # Run migrations and seed at container start so Supabase receives the seeded data,
    # then start the dev server. This uses the DATABASE_URL (or Databaseurl) env var.
    command: sh -c "npx prisma migrate deploy --preview-feature || true && npm run start:dev"
    # Run migrations and seed at container start so Supabase receives the seeded data,
    # then start the dev server. This uses the DATABASE_URL (or Databaseurl) env var.

  # ==========================================
  # Next.js Frontend Service
  # ==========================================
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: trash2cash-frontend
    restart: unless-stopped
    ports:
      # Expose frontend on host port 3000
      - "3000:3000"
    environment:
      # Backend API URL for client-side requests (from browser)
      # Must use localhost since browser can't resolve Docker service names
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000/api}
      NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      NODE_ENV: ${NODE_ENV:-development}
    volumes:
      # Mount source code for hot reload in development
      - ./client/app:/app/app
      - ./client/components:/app/components
      - ./client/lib:/app/lib
      - ./client/hooks:/app/hooks
      - ./client/public:/app/public
      # Persist node_modules and build output from the image
      - .next:/app/.next
      - node_modules:/app/node_modules
    depends_on:
      - backend
    networks:
      - trash2cash-network

# ==========================================
# Networks
# ==========================================
networks:
  trash2cash-network:
    driver: bridge

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres_data:
    driver: local
  node_modules:
    driver: local
