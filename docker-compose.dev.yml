# ============================================
# Docker Compose Configuration
# Full-Stack Application: PostgreSQL + NestJS + Next.js
# ============================================

services:
  # ==========================================
  # PostgreSQL Database Service (OPTIONAL - Local Development)
  # ==========================================
  # Uncomment this service if you want to use a local database
  # instead of the external Supabase database
  db:
    image: postgres:16-alpine
    container_name: trash2treasure-db
    restart: unless-stopped
    profiles:
      - local-db
    environment:
      POSTGRES_USER: trash2treasure
      POSTGRES_PASSWORD: trash2treasure_dev_password
      POSTGRES_DB: trash2treasure
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - trash2treasure-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trash2treasure"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # NestJS Backend Service
  # ==========================================

  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: trash2treasure-backend
    restart: unless-stopped
    ports:
      # Expose backend on host port 4000
      - "4000:4000"
    environment:
      # Database connection (using external Supabase database)
      # Use explicit DATABASE_URL only
      DATABASE_URL: ${DATABASE_URL}
      DIRECT_URL: ${DIRECT_URL}
      # Default to pooled DATABASE_URL for broader local-network compatibility.
      # Set PRISMA_PREFER_DIRECT_URL=true explicitly if you need DIRECT_URL.
      PRISMA_PREFER_DIRECT_URL: ${PRISMA_PREFER_DIRECT_URL:-false}
      # Retry database connection on startup for transient network issues
      PRISMA_CONNECT_RETRIES: ${PRISMA_CONNECT_RETRIES:-8}
      PRISMA_CONNECT_RETRY_DELAY_MS: ${PRISMA_CONNECT_RETRY_DELAY_MS:-2000}

      # Application settings
      PORT: ${PORT:-4000}
      NODE_ENV: ${NODE_ENV:-development}

      # JWT secrets (change these in production!)
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_ACCESS_EXPIRES: ${JWT_ACCESS_EXPIRES:-15m}
      JWT_REFRESH_EXPIRES: ${JWT_REFRESH_EXPIRES:-7d}

      # CORS - allow frontend to communicate with backend
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}

      # External API keys (loaded from .env file)
      GEMINI_API_KEY: ${GEMINI_API_KEY}

      # Text.lk SMS Gateway
      TEXTLK_API_TOKEN: ${TEXTLK_API_TOKEN}
      TEXTLK_SENDER_ID: ${TEXTLK_SENDER_ID:-TextLKDemo}

      # reCAPTCHA (server)
      RECAPTCHA_SECRET: ${RECAPTCHA_SECRET}
      RECAPTCHA_MIN_SCORE: ${RECAPTCHA_MIN_SCORE:-0.5}
      RECAPTCHA_ENABLED: ${RECAPTCHA_ENABLED:-true}

      # Google OAuth (server-side auth-code exchange)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}

      # Web Push (VAPID) - provided from project .env or environment
      VAPID_PUBLIC_KEY: ${VAPID_PUBLIC_KEY}
      VAPID_PRIVATE_KEY: ${VAPID_PRIVATE_KEY}
      VAPID_SUBJECT: ${VAPID_SUBJECT:-mailto:admin@trash2treasure.lk}
    volumes:
      # Mount source code for hot reload in development
      - ./server/src:/app/src
      - ./server/prisma:/app/prisma
      # Persist logs
      - ./server/logs:/app/logs
      # Persist node_modules from the image (do not mount host path here)
    networks:
      - trash2treasure-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:4000/api || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s
    # Run migrations and seed at container start so Supabase receives the seeded data,
    # then start the dev server. This uses the DATABASE_URL env var.
    command: sh -c "npx prisma migrate deploy || true && npm run start:dev"

  # ==========================================
  # Next.js Frontend Service
  # ==========================================
  frontend:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: trash2treasure-frontend
    restart: unless-stopped
    ports:
      # Expose frontend on host port 3000
      - "3000:3000"
    environment:
      # Backend API URL for client-side requests (from browser)
      # Must use localhost since browser can't resolve Docker service names
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:4000/api}
      # Internal backend URL for server-side requests (SSR) within Docker network
      INTERNAL_API_URL: http://backend:4000/api
      NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${NEXT_PUBLIC_GOOGLE_CLIENT_ID}
      NEXT_PUBLIC_GOOGLE_MAPS_API_KEY: ${NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}
      NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${NEXT_PUBLIC_RECAPTCHA_SITE_KEY}
      NEXT_PUBLIC_RECAPTCHA_ENABLED: ${NEXT_PUBLIC_RECAPTCHA_ENABLED:-true}
      NEXT_PUBLIC_FIREBASE_API_KEY: ${NEXT_PUBLIC_FIREBASE_API_KEY}
      NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET: ${NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET}
      NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID: ${NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID}
      NEXT_PUBLIC_FIREBASE_APP_ID: ${NEXT_PUBLIC_FIREBASE_APP_ID}
      NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID: ${NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID}
      NODE_ENV: ${NODE_ENV:-development}
    volumes:
      # Mount source code for hot reload in development
      - ./client/app:/app/app
      - ./client/components:/app/components
      - ./client/lib:/app/lib
      - ./client/hooks:/app/hooks
      - ./client/public:/app/public
      # Persist node_modules and build output from the image
      - .next:/app/.next
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - trash2treasure-network

# ==========================================
# Networks
# ==========================================
networks:
  trash2treasure-network:
    driver: bridge

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres_data:
    driver: local
  node_modules:
    driver: local

